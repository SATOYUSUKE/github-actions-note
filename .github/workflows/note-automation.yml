name: Note Automation Workflow

on:
  workflow_dispatch:
    inputs:
      theme:
        description: 'ðŸ“ è¨˜äº‹ã®ãƒ†ãƒ¼ãƒž (ä¾‹: AIæŠ€è¡“ã®æœ€æ–°å‹•å‘)'
        required: true
        type: string
        default: 'AIæŠ€è¡“ã®æœ€æ–°å‹•å‘'
      target:
        description: 'ðŸ‘¥ æƒ³å®šèª­è€… (ä¾‹: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢åˆå¿ƒè€…)'
        required: true
        type: string
        default: 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢åˆå¿ƒè€…'
      message:
        description: 'ðŸ’¡ ä¼ãˆãŸã„æ ¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (ä¾‹: æŠ€è¡“ã®é€²æ­©ã§ç”Ÿç”£æ€§å‘ä¸Š)'
        required: true
        type: string
        default: 'æŠ€è¡“ã®é€²æ­©ã§ç”Ÿç”£æ€§å‘ä¸Š'
      cta:
        description: 'ðŸŽ¯ èª­å¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (ä¾‹: å®Ÿéš›ã«è©¦ã—ã¦ã¿ã‚‹)'
        required: true
        type: string
        default: 'å®Ÿéš›ã«è©¦ã—ã¦ã¿ã‚‹'
      tags:
        description: 'ðŸ·ï¸ ã‚¿ã‚° (ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šã€æœ€å¤§5å€‹)'
        required: true
        type: string
        default: 'AI,æŠ€è¡“,è‡ªå‹•åŒ–'
      writing_style:
        description: 'âœï¸ è¨˜äº‹ã®ã‚¹ã‚¿ã‚¤ãƒ« (casual/informative/technical/academic)'
        required: false
        type: string
        default: 'informative'
      content_length:
        description: 'ðŸ“ è¨˜äº‹ã®é•·ã• (short/medium/long)'
        required: false
        type: string
        default: 'medium'
      is_public:
        description: 'ðŸŒ å…¬é–‹è¨­å®š'
        required: true
        type: boolean
        default: false
      dry_run:
        description: 'ðŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (å®Ÿéš›ã®æŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—)'
        required: true
        type: boolean
        default: true
  schedule:
    # æ¯Žæ—¥åˆå‰9æ™‚ã«å®Ÿè¡Œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    - cron: '0 0 * * *'

jobs:
  research:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      research-report: ${{ steps.research.outputs.report }}
      research-progress: ${{ steps.research.outputs.research_job_progress }}
      monitoring-present: ${{ steps.monitoring.outputs.present }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Initialize Workflow Monitoring
        run: |
          echo "WORKFLOW_START_TIME=$(date -u +%s)" >> $GITHUB_ENV
          echo "JOB_START_TIME=$(date -u +%s)" >> $GITHUB_ENV
          
          # ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®è¦‹ã‚„ã™ã„ã‚µãƒžãƒªãƒ¼
          echo "# ðŸš€ Noteè‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ†” ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ID | \`${{ github.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| â° é–‹å§‹æ™‚åˆ» | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ ãƒ†ãƒ¼ãƒž | ${{ github.event.inputs.theme || 'AIæŠ€è¡“ã®æœ€æ–°å‹•å‘' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¥ æƒ³å®šèª­è€… | ${{ github.event.inputs.target || 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢åˆå¿ƒè€…' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœï¸ ã‚¹ã‚¿ã‚¤ãƒ« | ${{ github.event.inputs.writing_style || 'informative' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ é•·ã• | ${{ github.event.inputs.content_length || 'medium' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” ãƒªã‚µãƒ¼ãƒæ·±åº¦ | ${{ github.event.inputs.research_depth || 'standard' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ | ${{ github.event.inputs.dry_run || 'true' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š é€²æ—çŠ¶æ³" >> $GITHUB_STEP_SUMMARY
          echo "- [x] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] ãƒªã‚µãƒ¼ãƒå®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] è¨˜äº‹åŸ·ç­†" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] æŠ•ç¨¿å‡¦ç†" >> $GITHUB_STEP_SUMMARY
      
      - name: Run Research Job
        id: research
        run: node jobs/research-job.js
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          THEME: ${{ github.event.inputs.theme || 'AIæŠ€è¡“ã®æœ€æ–°å‹•å‘' }}
          TARGET: ${{ github.event.inputs.target || 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢åˆå¿ƒè€…' }}
          MESSAGE: ${{ github.event.inputs.message || 'æŠ€è¡“ã®é€²æ­©ã§ç”Ÿç”£æ€§å‘ä¸Š' }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_JOB: research
      
      - name: Research Job Summary
        if: always()
        run: |
          JOB_END_TIME=$(date -u +%s)
          JOB_DURATION=$((JOB_END_TIME - JOB_START_TIME))
          
          # ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®çµæžœè¡¨ç¤º
          echo "## ðŸ“Š ãƒªã‚µãƒ¼ãƒçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
          if [ "${{ job.status }}" = "success" ]; then
            echo "![Status](https://img.shields.io/badge/ãƒªã‚µãƒ¼ãƒ-âœ…_å®Œäº†-brightgreen)" >> $GITHUB_STEP_SUMMARY
          else
            echo "![Status](https://img.shields.io/badge/ãƒªã‚µãƒ¼ãƒ-âŒ_å¤±æ•—-red)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # çµæžœãƒ†ãƒ¼ãƒ–ãƒ«
          echo "| ðŸ“ˆ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| â±ï¸ å®Ÿè¡Œæ™‚é–“ | ${JOB_DURATION}ç§’ |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "outputs/research-report.json" ]; then
            KEY_POINTS=$(jq -r '.keyPoints | length' outputs/research-report.json 2>/dev/null || echo "0")
            SOURCES=$(jq -r '.sources | length' outputs/research-report.json 2>/dev/null || echo "0")
            QUALITY=$(jq -r '.metadata.qualityScore * 100 | floor' outputs/research-report.json 2>/dev/null || echo "0")
            
            echo "| ðŸ”‘ é‡è¦ãƒã‚¤ãƒ³ãƒˆ | ${KEY_POINTS}å€‹ |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“š æƒ…å ±æº | ${SOURCES}å€‹ |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ å“è³ªã‚¹ã‚³ã‚¢ | ${QUALITY}% |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # é€²æ—æ›´æ–°
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š å…¨ä½“é€²æ—" >> $GITHUB_STEP_SUMMARY
          echo "- [x] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹" >> $GITHUB_STEP_SUMMARY
          echo "- [x] ãƒªã‚µãƒ¼ãƒå®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] è¨˜äº‹åŸ·ç­†" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] æŠ•ç¨¿å‡¦ç†" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Research Report
        uses: actions/upload-artifact@v4
        with:
          name: research-report
          path: outputs/research-report.json
          retention-days: 1
      
      - name: Upload Error Reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: research-errors
          path: outputs/errors/
          retention-days: 7
      
      - name: Check Monitoring Files
        id: monitoring
        run: |
          if [ -d "outputs/monitoring" ] && [ -n "$(find outputs/monitoring -type f -print -quit 2>/dev/null)" ]; then
            echo "present=true" >> $GITHUB_OUTPUT
          else
            echo "present=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload Monitoring Data
        if: ${{ steps.monitoring.outputs.present == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: research-monitoring
          path: outputs/monitoring/
          retention-days: 3
          if-no-files-found: ignore

  writing:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: research
    outputs:
      article: ${{ steps.writing.outputs.article }}
      writing-progress: ${{ steps.writing.outputs.writing_job_progress }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Initialize Job Monitoring
        run: |
          echo "JOB_START_TIME=$(date -u +%s)" >> $GITHUB_ENV
          echo "## âœï¸ Writing Job Starting" >> $GITHUB_STEP_SUMMARY
      
      - name: Download Research Report
        uses: actions/download-artifact@v4
        with:
          name: research-report
          path: inputs/
      
      - name: Download Research Monitoring
        if: ${{ needs.research.outputs.monitoring-present == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: research-monitoring
          path: inputs/monitoring/
      
      - name: Run Writing Job
        id: writing
        run: node jobs/writing-job.js
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          THEME: ${{ github.event.inputs.theme || 'AIæŠ€è¡“ã®æœ€æ–°å‹•å‘' }}
          TARGET: ${{ github.event.inputs.target || 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢åˆå¿ƒè€…' }}
          MESSAGE: ${{ github.event.inputs.message || 'æŠ€è¡“ã®é€²æ­©ã§ç”Ÿç”£æ€§å‘ä¸Š' }}
          CTA: ${{ github.event.inputs.cta || 'å®Ÿéš›ã«è©¦ã—ã¦ã¿ã‚‹' }}
          TAGS: ${{ github.event.inputs.tags || 'AI,æŠ€è¡“,è‡ªå‹•åŒ–' }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_JOB: writing
      
      - name: Writing Job Summary
        if: always()
        run: |
          JOB_END_TIME=$(date -u +%s)
          JOB_DURATION=$((JOB_END_TIME - JOB_START_TIME))
          echo "## ðŸ“ Writing Job Results" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${JOB_DURATION}s" >> $GITHUB_STEP_SUMMARY
          if [ -f "outputs/article-draft.json" ]; then
            echo "**Title:** $(jq -r '.title' outputs/article-draft.json)" >> $GITHUB_STEP_SUMMARY
            echo "**Word Count:** $(jq -r '.originalArticle.metadata.wordCount' outputs/article-draft.json)" >> $GITHUB_STEP_SUMMARY
            echo "**Quality Score:** $(jq -r '.originalArticle.qualityScore * 100 | floor')%" outputs/article-draft.json >> $GITHUB_STEP_SUMMARY
            echo "**Reading Time:** $(jq -r '.originalArticle.metadata.estimatedReadingTime')min" outputs/article-draft.json >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload Article Draft
        uses: actions/upload-artifact@v4
        with:
          name: article-draft
          path: outputs/article-draft.json
          retention-days: 1
      
      - name: Upload Error Reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: writing-errors
          path: outputs/errors/
          retention-days: 7
      
      - name: Upload Monitoring Data
        if: ${{ hashFiles('outputs/monitoring/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: writing-monitoring
          path: outputs/monitoring/
          retention-days: 3
          if-no-files-found: ignore

  fact-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: writing
    outputs:
      verified-article: ${{ steps.fact-check.outputs.verified-article }}
      fact-check-progress: ${{ steps.fact-check.outputs.fact_check_job_progress }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Initialize Job Monitoring
        run: |
          echo "JOB_START_TIME=$(date -u +%s)" >> $GITHUB_ENV
          echo "## ðŸ” Fact Check Job Starting" >> $GITHUB_STEP_SUMMARY
      
      - name: Download Article Draft
        uses: actions/download-artifact@v4
        with:
          name: article-draft
          path: inputs/
      
      - name: Download Research Report
        uses: actions/download-artifact@v4
        with:
          name: research-report
          path: inputs/
      
      - name: Run Fact Check Job
        id: fact-check
        run: node jobs/fact-check-job.js
        env:
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_JOB: fact-check
      
      - name: Fact Check Job Summary
        if: always()
        run: |
          JOB_END_TIME=$(date -u +%s)
          JOB_DURATION=$((JOB_END_TIME - JOB_START_TIME))
          echo "## ðŸ” Fact Check Job Results" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${JOB_DURATION}s" >> $GITHUB_STEP_SUMMARY
          if [ -f "outputs/verified-article.json" ]; then
            echo "**Overall Score:** $(jq -r '.factCheck.overallScore * 100 | floor')%" outputs/verified-article.json >> $GITHUB_STEP_SUMMARY
            echo "**Claims Verified:** $(jq -r '.factCheck.claimsVerified' outputs/verified-article.json)" >> $GITHUB_STEP_SUMMARY
            echo "**Corrections Applied:** $(jq -r '.factCheck.correctionsApplied' outputs/verified-article.json)" >> $GITHUB_STEP_SUMMARY
            echo "**Readiness Level:** $(jq -r '.factCheck.finalValidation.readinessLevel' outputs/verified-article.json)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload Verified Article
        uses: actions/upload-artifact@v4
        with:
          name: verified-article
          path: outputs/verified-article.json
          retention-days: 1
      
      - name: Upload Fact Check Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fact-check-reports
          path: outputs/fact-check/
          retention-days: 7
      
      - name: Upload Error Reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fact-check-errors
          path: outputs/errors/
          retention-days: 7
      
      - name: Upload Monitoring Data
        if: ${{ hashFiles('outputs/monitoring/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: fact-check-monitoring
          path: outputs/monitoring/
          retention-days: 3
          if-no-files-found: ignore

  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: fact-check
    outputs:
      publish-result: ${{ steps.publish.outputs.publish-result }}
      publish-progress: ${{ steps.publish.outputs.publishing_job_progress }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install chromium
      
      - name: Initialize Job Monitoring
        run: |
          echo "JOB_START_TIME=$(date -u +%s)" >> $GITHUB_ENV
          echo "## ðŸ“¤ Publishing Job Starting" >> $GITHUB_STEP_SUMMARY
      
      - name: Download Verified Article
        uses: actions/download-artifact@v4
        with:
          name: verified-article
          path: inputs/
      
      - name: Run Publishing Job
        id: publish
        run: node jobs/publishing-job.js
        env:
          NOTE_STORAGE_STATE_JSON: ${{ secrets.NOTE_STORAGE_STATE_JSON }}
          IS_PUBLIC: ${{ github.event.inputs.is_public || 'false' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_JOB: publish
      
      - name: Publishing Job Summary
        if: always()
        run: |
          JOB_END_TIME=$(date -u +%s)
          JOB_DURATION=$((JOB_END_TIME - JOB_START_TIME))
          echo "## ðŸ“¤ Publishing Job Results" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${JOB_DURATION}s" >> $GITHUB_STEP_SUMMARY
          if [ -f "outputs/publishing-results.json" ]; then
            echo "**Result:** $(jq -r '.status' outputs/publishing-results.json)" >> $GITHUB_STEP_SUMMARY
            echo "**Success:** $(jq -r '.success' outputs/publishing-results.json)" >> $GITHUB_STEP_SUMMARY
            if [ "$(jq -r '.noteUrl' outputs/publishing-results.json)" != "null" ]; then
              echo "**Note URL:** $(jq -r '.noteUrl' outputs/publishing-results.json)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "**Screenshots:** $(jq -r '.screenshots | length' outputs/publishing-results.json)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload Screenshots
        if: ${{ hashFiles('outputs/screenshots/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: publishing-screenshots
          path: outputs/screenshots/
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Upload Publishing Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: publishing-results
          path: outputs/publishing-results.json
          retention-days: 7
      
      - name: Upload Error Reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: publishing-errors
          path: outputs/errors/
          retention-days: 7
      
      - name: Upload Monitoring Data
        if: ${{ hashFiles('outputs/monitoring/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: publishing-monitoring
          path: outputs/monitoring/
          retention-days: 3
          if-no-files-found: ignore

  # åŒ…æ‹¬çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  workflow-summary:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [research, writing, fact-check, publish]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download All Monitoring Data
        uses: actions/download-artifact@v4
        with:
          pattern: "*-monitoring"
          path: monitoring-data/
          merge-multiple: true
        continue-on-error: true
      
      - name: Download All Error Reports
        uses: actions/download-artifact@v4
        with:
          pattern: "*-errors"
          path: error-data/
          merge-multiple: true
        continue-on-error: true
      
      - name: Generate Comprehensive Report
        run: node utils/generate-workflow-report.js
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
          WORKFLOW_START_TIME: ${{ env.WORKFLOW_START_TIME }}
          RESEARCH_STATUS: ${{ needs.research.result }}
          WRITING_STATUS: ${{ needs.writing.result }}
          FACT_CHECK_STATUS: ${{ needs.fact-check.result }}
          PUBLISH_STATUS: ${{ needs.publish.result }}
      
      - name: Final Workflow Summary
        if: always()
        run: |
          WORKFLOW_END_TIME=$(date -u +%s)
          TOTAL_DURATION=$((WORKFLOW_END_TIME - WORKFLOW_START_TIME))
          echo "# ðŸŽ‰ Workflow Completed" >> $GITHUB_STEP_SUMMARY
          echo "**Total Duration:** ${TOTAL_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "**Research:** ${{ needs.research.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Writing:** ${{ needs.writing.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fact Check:** ${{ needs.fact-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Publishing:** ${{ needs.publish.result }}" >> $GITHUB_STEP_SUMMARY
          
          # æˆåŠŸçŽ‡ã‚’è¨ˆç®—
          SUCCESS_COUNT=0
          if [ "${{ needs.research.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.writing.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.fact-check.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.publish.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          
          SUCCESS_RATE=$((SUCCESS_COUNT * 25))
          echo "**Success Rate:** ${SUCCESS_RATE}%" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "outputs/workflow-report.json" ]; then
            echo "**API Calls:** $(jq -r '.apiUsage.summary.totalAPICalls' outputs/workflow-report.json)" >> $GITHUB_STEP_SUMMARY
            echo "**API Success Rate:** $(jq -r '.apiUsage.summary.overallSuccessRate')%" outputs/workflow-report.json >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload Comprehensive Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-comprehensive-report
          path: outputs/workflow-report.json
          retention-days: 30
      
      - name: Upload Performance Analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-analysis
          path: outputs/performance-analysis.json
          retention-days: 30